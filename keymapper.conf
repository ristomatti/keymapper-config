# Immediately forward common modifiers
MetaLeft      >> MetaLeft
MetaRight     >> MetaRight
Control       >> Control
AltLeft       >> AltLeft
AltRight      >> AltRight
ShiftLeft     >> ShiftLeft
ShiftRight    >> ShiftRight

# Virtual modifier state files
STATE_DIR             = $HOME/.local/state/keymapper/virtual
AUTO_SHIFT_FILE       = STATE_DIR/AutoShift
DIRECT_UMLAUTS_FILE   = STATE_DIR/DirectUmlauts
CAPS_WORD_FILE        = STATE_DIR/CapsWord
#/

notify = 'notify-send' -t 5000 keymapper
debug  = 'notify-send' -t 500 keymapper

# Create state directory if it doesn't exist
ensureStateDirExists       = test -f STATE_DIR || mkdir -p STATE_DIR

# Input mode status bar indicator togglins
auto_shift_status_on       = $(ensureStateDirExists && touch AUTO_SHIFT_FILE)
auto_shift_status_off      = $(test -f AUTO_SHIFT_FILE && rm AUTO_SHIFT_FILE)

direct_umlauts_status_on   = $(ensureStateDirExists && touch DIRECT_UMLAUTS_FILE)
direct_umlauts_status_off  = $(test -f DIRECT_UMLAUTS_FILE && rm DIRECT_UMLAUTS_FILE)

caps_word_status_on        = $(ensureStateDirExists && touch CAPS_WORD_FILE)
caps_word_status_off       = $(test -f CAPS_WORD_FILE && rm CAPS_WORD_FILE)

# Allow using Alt as modifier without breaking window move/resize with Alt held
Alt             = !ButtonLeft !ButtonRight AltLeft

# Intl. layout modifiers
AltGr           = AltRight

# Exact modifiers
_Meta           = !ControlLeft !ControlRight           !MetaRight !AltLeft !AltGr MetaLeft
_MetaRight      = !ControlLeft !ControlRight !MetaLeft            !AltLeft !AltGr MetaRight
_Alt            = !ControlLeft !ControlRight !MetaLeft !MetaRight          !AltGr AltLeft
_AltGr          = !ControlLeft !ControlRight !MetaLeft !MetaRight !AltLeft        AltGr
_Control        =              !ControlRight !MetaLeft !MetaRight !AltLeft !AltGr ControlLeft
_ControlRight   = !ControlLeft               !MetaLeft !MetaRight !AltLeft !AltGr ControlRight
_Shift          = !ControlLeft !ControlRight !MetaLeft !MetaRight !AltLeft !AltGr ShiftLeft
_ShiftRight     = !ControlLeft !ControlRight !MetaLeft !MetaRight !AltLeft !AltGr ShiftRight

# Modifier groups
EitherControl   = ControlLeft | ControlRight
EitherAlt       = AltLeft | AltGr
EitherMeta      = MetaLeft | MetaRight
EitherShift     = ShiftLeft | ShiftRight

# Special keys
File            = 144
Menu            = 130
Search          = 217
Stop            = 128

Back            = 158
Forward         = 159
Bookmarks       = 156
Refresh         = 173


# Logitech G502 X
ButtonSide      = 277

# Key groups
MouseButton     = ButtonLeft | ButtonRight | ButtonMiddle | ButtonBack | ButtonForward
Number          = 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9
Letter          = A | B | C | D | E | F | G | H | I | J | K | L | M | N | O | P | Q | R | S | T | U | V | W | X | Y | Z

# Directional navigation keys
KeyUp           = I
KeyLeft         = J
KeyDown         = K
KeyRight        = L
Direction       = KeyUp | KeyLeft | KeyDown | KeyRight

# Window manager shortcut keys
Workspace       = Number | M | P | Minus
ScratchpadBind  = O | S | G | R | G | X | Y | Tab
WMLeaderBind    = O | S | G | R | V | X | Y
WMShortcut      = Workspace | ScratchpadBind | Enter | Space | Escape | Tab | C | F | R | A | Z | W | V | H | N | X

WMScratchpad    = F13
WMLeader        = F15
SwapKbdLayout   = F16
AudioMicMute    = F20

# Input mode toggle keys
CapsWord        = Virtual1
AutoShift       = Virtual2
DirectUmlauts   = Virtual3

# Input source ids
GnomeInputSourceUS = 0
GnomeInputSourceFI = 1

# Device matchers
KeyboardK15Pro        = /Keychron K15 Pro Keyboard$/i
KeyboardK15ProMedia   = /Keychron K15 Pro Consumer Control$/i
KeyboardK15ProSystem  = /Keychron K15 Pro System Control$/i
KeyboardK15ProMouse   = /Keychron K15 Pro Mouse$/i

KeyboardK3Pro         = /Keychron K3 Pro Keyboard$/i

MouseG502X            = /Logitech USB Receiver$/i
MouseMXAnywhere       = /MX Anywhere 2S Mouse$/i

# CapsWord emulation (https://docs.qmk.fm/#/feature_caps_word)
[default]
  CapsWordKey = Letter | Number | Minus | Backspace

  Shift{200ms}          >> Shift
  ShiftLeft{ShiftRight} >> CapsWord CapsLock ^

  CapsWord >> caps_word_status_on ^ caps_word_status_off

[modifier="CapsWord"]
  Minus                 >> Shift{Minus} # '_'
  CapsWordKey           >> CapsWordKey
  !CapsWordKey Any      >> CapsWord CapsLock Any ^


# DirectUmlauts
[default]
  DirectUmlauts  = Virtual3
  DirectUmlauts >> direct_umlauts_status_on ^ direct_umlauts_status_off

[modifier="!Meta !Control DirectUmlauts" title=/Gmail|Outlook|Slack|WhatsApp|TickTick/i]
  Shift{Comma}          >> (Shift Semicolon)
  ShiftRight{2}         >> (Shift Quote)

  Quote{120ms}          >> Quote ^
  Semicolon{120ms}      >> Semicolon ^
  AltGr{Quote}          >> !AltGr Quote
  AltGr{Semicolon}      >> !AltGr Semicolon
  Quote                 >> AltGr{Q}
  Semicolon             >> AltGr{P}


# AutoShift emulation (https://docs.qmk.fm/#/feature_auto_shift)
[default]
  AutoShift = Virtual2
  AutoShifted = BracketLeft | BracketRight | Number | Minus | Equal | Comma | Period | Semicolon | Quote

  AutoShift >> auto_shift_status_on ^ auto_shift_status_off

[modifier="!Meta !AltGr !Control AutoShift"]
  Shift{AutoShifted}                >> (Shift AutoShifted)
  AutoShifted{120ms} !AutoShifted   >> (Shift AutoShifted)
  AutoShifted{Any}                  >> AutoShifted Any ^
  AutoShifted                       >> AutoShifted


# Keychron K15 Pro media keys
[device=KeyboardK15ProMedia]
  Any >> Any

# Keychron K15 Pro system keys
[device=KeyboardK15ProSystem]
  Any >> Any

# Keychron K15 Pro mouse buttons
[device=KeyboardK15ProMouse]
  Any >> Any


# Default mappings
[default]
  Leader = Comma


# Defaults // Keychron K3 Pro
[device=KeyboardK3Pro]
  Backquote     >> WMScratchpad    # F13
  BracketRight  >> WMLeader{200ms} # F15


# Neovim, Vim // Keychron K3 Pro
[device=KeyboardK3Pro title=/^.* - N?VIM$/]
  BracketLeft   >> Escape


# Key definitions // Keychron K15 Pro
[device=KeyboardK15Pro]
  SpaceLeft     = MetaRight
  CapsLockTap   = ControlRight

  # Left side macro keys
  Macro1        = F13
  Option        = ScrollLock
  Command       = ContextMenu
  Lock          = F16

  # Rotary encoder
  EncoderButton = NumpadEnter
  EncoderRight  = NumpadAdd
  EncoderLeft   = NumpadSubtract


# Encoder mappings for Rofi // Keychron K15 Pro
[device=KeyboardK15Pro title=/rofi/i]
  EncoderButton   >> Enter ^
  EncoderRight    >> ArrowDown
  EncoderLeft     >> ArrowUp


# Slack // Keychron K15 Pro
[class="slack" device=KeyboardK15Pro]
  Escape{F}       >> slack_switch_channel
  Escape{1}       >> slack_goto_workspace1
  Escape{2}       >> slack_goto_workspace2
  Escape{H}       >> slack_goto_home
  Escape{A}       >> slack_goto_activity
  Escape{D}       >> slack_goto_dms
  Escape{T}       >> slack_goto_threads
  Escape{L}       >> slack_goto_later
  Escape{U}       >> slack_goto_unread
  Escape{M}       >> slack_mic_mute_toggle
  Escape{Space}   >> slack_switch_channel


# Browser // Keychron K15 Pro
[class=/chrome|chromium|lights-ui/i device=KeyboardK15Pro]
  Escape{T}       >> new_tab
  Escape{W}       >> close_tab
  Escape{L}       >> goto_location
  Escape{Z}       >> suspend_tab
  Escape{B}       >> navigate_back
  Escape{F}       >> navigate_forward
  Escape{N}       >> F7


# Default mappings // Keychron K15 Pro
[device=KeyboardK15Pro]
  OptionShortcutKey = Any
  Macro1                              >> show_scene_picker

  Option{Tab}                         >> DirectUmlauts ^
  Option{Any}                         >>
  Option                              >> AutoShift ^

  Command{Space}                      >> show_run_menu
  Command{Tab}                        >> show_window_switcher
  Command{Lock}                       >> wm_lock_desktop
  Command{WMLeaderBind}               >> WMLeader{WMLeaderBind}
  Command                             >> WMLeader

  # Switch keyboard layout
  Lock{Tab}                           >> F16 ^
  Lock{ShiftLeft}                     >> set_keyboard_layout_fi
  Lock                                >> set_keyboard_layout_us

  # Disable default leader key
  Leader{Any}                         >> Leader Any
  Leader                              >> Leader

  # Encoder brightness control
  (ControlRight Shift){EncoderButton} >> brightness_reset
  (ControlRight Shift){EncoderRight}  >> brightness_increase
  (ControlRight Shift){EncoderLeft}   >> brightness_decrease

  # Encoder color temp control
  ControlRight{EncoderButton}         >> color_temp_reset
  ControlRight{EncoderRight}          >> color_temp_increase
  ControlRight{EncoderLeft}           >> color_temp_decrease

  # Encoder media control
  AltGr{EncoderButton}                >> !AltGr MediaStop ^
  AltGr{EncoderRight}                 >> !AltGr MediaTrackNext
  AltGr{EncoderLeft}                  >> !AltGr MediaTrackPrevious

  # Encoder audio control
  EncoderButton                       >> MediaPlayPause ^
  EncoderRight                        >> AudioVolumeUp
  EncoderLeft                         >> AudioVolumeDown

  # Directional tiled window movement
  (SpaceLeft Shift){KeyUp}            >> Meta{Shift{ArrowUp}}
  (SpaceLeft Shift){KeyLeft}          >> Meta{Shift{ArrowLeft}}
  (SpaceLeft Shift){KeyDown}          >> Meta{Shift{ArrowDown}}
  (SpaceLeft Shift){KeyRight}         >> Meta{Shift{ArrowRight}}

  # WM shortcuts used with MetaLeft
  SpaceLeft{WMShortcut}               >> Meta{WMShortcut}

  # Window navigation
  SpaceLeft{KeyUp}                    >> Meta{ArrowUp}
  SpaceLeft{KeyLeft}                  >> Meta{ArrowLeft}
  SpaceLeft{KeyDown}                  >> Meta{ArrowDown}
  SpaceLeft{KeyRight}                 >> Meta{ArrowRight}

  SpaceLeft{Comma}                    >> show_emoji_picker
  SpaceLeft{E}                        >> show_emoji_picker
  SpaceLeft{Q}                        >> wm_close_window
  SpaceLeft{BracketLeft}              >> wm_show_terminal
  SpaceLeft{Backquote}                >> wm_show_scratchpad

  # Editor actions
  AltGr{Insert}                       >> End
  AltGr{Backspace}                    >> Delete

  # Nordic layout mappings
  AltGr{A}                            >> _AltGr{Q}
  AltGr{O}                            >> _AltGr{P}
  AltGr{E}                            >> AltGr{5}        # '€'
  AltGr{2}                            >> !AltGr Shift{2} # '@'
  AltGr{4}                            >> !AltGr Shift{4} # '$'
  AltGr{BracketLeft}                  >> !AltGr Shift{9} # '('
  AltGr{BracketRight}                 >> !AltGr Shift{0} # ')'

  # Long-pres shortcuts
  Backslash{120ms}                    >> wm_show_terminal
  Backslash                           >> Backslash
  Backquote{110ms}                    >> WMScratchpad
  Backquote                           >> Backquote


# Mouse buttons // Logitech G502 X
[device=MouseG502X]
  ButtonForward{150ms}          >> mouse_drag
  ButtonBack{150ms}             >> mouse_drag_resize

  ButtonSide{!120ms} ButtonSide{!120ms} >> wm_move_to_scratchpad
  ButtonSide{ButtonLeft}        >> wm_float_window
  ButtonSide{ButtonMiddle}      >> wm_center_window
  ButtonSide{ButtonRight}       >> wm_close_window
  ButtonSide                    >> wm_show_scratchpad


# Mouse buttons // Logitech MX Anywhere 2S
[device=MouseMXAnywhere]
  ButtonMiddle{150ms}           >> wm_float_window


# Jetbrains IDE defaults
[class=/jetbrains/]
  Editor    = E
  Focus     = F
  Goto      = G

  FocusKey  = Direction | N | P

  Editor{Direction}     >> AltGr{Control{Direction}}
  Editor{Any}           >> Editor Any

  Focus{FocusKey}       >> AltGr{AltLeft{FocusKey}}
  Focus{Any}            >> Focus Any

  Goto{D}               >> goto_declaration
  Goto{I}               >> goto_implementation
  Goto{F}               >> goto_file
  Goto{S}               >> goto_symbol
  Goto{Any}             >> Goto Any

  Editor{!75ms}         >> Editor
  Focus{!75ms}          >> Focus
  Goto{!75ms}           >> Goto

  _Shift{Enter}         >> End

  goto_declaration      >> Control{B}
  goto_implementation   >> Control{AltLeft{B}}
  goto_file             >> AltLeft{P}
  goto_symbol           >> AltLeft{Shift{P}}


[title="Microsoft Teams"]
  Escape{M}             >> Control{Shift{M}}
  EitherAlt{M}          >> Control{Shift{M}}

  toggle_mic_mute       >> Control{Shift{M}}

# Browser defaults
[class=/chrome|chromium|firefox|lights-ui/i]
  Leader{T}             >> new_tab
  Leader{X}             >> close_tab
  Leader{L}             >> goto_location

  EitherAlt{T}          >> new_tab
  EitherAlt{W}          >> close_tab
  Alt{PageUp}           >> prev_tab
  Alt{PageDown}         >> next_tab

  AltGr{P}              >> pin_tab
  AltGr{Z}              >> suspend_tab

  Alt{KeyLeft}          >> prev_tab
  Alt{KeyRight}         >> next_tab
  Alt{KeyUp}            >> scroll_up
  Alt{KeyDown}          >> scroll_down

  # Azure DevOps next change
  Alt{N}                >> F7

  goto_location         >> _Control{L}
  pin_tab               >> _Alt{P}
  scroll_up             >> ArrowUp ArrowUp ArrowUp ArrowUp ArrowUp ArrowUp ArrowUp ArrowUp
  scroll_down           >> ArrowDown ArrowDown ArrowDown ArrowDown ArrowDown ArrowDown ArrowDown ArrowDown
  suspend_tab           >> _Alt{Z}


# Slack defaults
[class="slack"]
  Leader{F}             >> slack_switch_channel
  Leader{1}             >> slack_goto_workspace1
  Leader{2}             >> slack_goto_workspace2
  Leader{H}             >> slack_goto_home
  Leader{A}             >> slack_goto_activity
  Leader{D}             >> slack_goto_dms
  Leader{T}             >> slack_goto_threads
  Leader{L}             >> slack_goto_later
  Leader{U}             >> slack_goto_unread
  Leader{M}             >> slack_mic_mute_toggle

  EitherAlt{Space}      >> slack_switch_channel
  EitherAlt{1}          >> slack_goto_workspace1
  EitherAlt{2}          >> slack_goto_workspace2
  EitherAlt{M}          >> slack_mic_mute_toggle
  Alt{Tab}              >> slack_next_section
  Alt{Shift{Tab}}       >> slack_prev_section
  Alt{KeyUp}            >> slack_prev_chat
  Alt{KeyDown}          >> slack_next_chat

  Alt{KeyLeft}          >> navigate_back
  Alt{KeyRight}         >> navigate_forward

  slack_goto_home       >> (Control Shift){1}
  slack_goto_dms        >> (Control Shift){2}
  slack_goto_activity   >> (Control Shift){3}
  slack_goto_later      >> (Control Shift){4}
  slack_goto_threads    >> (Control Shift){T}
  slack_goto_unread     >> (Control Shift){A}
  slack_switch_channel  >> Control{K}
  slack_mic_mute_toggle >> (Control Shift){Space}
  slack_next_chat       >> AltLeft{ArrowDown}
  slack_prev_chat       >> AltLeft{ArrowUp}
  slack_goto_workspace1 >> Control{1}
  slack_goto_workspace2 >> Control{2}
  slack_next_section    >> F6
  slack_prev_section    >> Shift{F6}


# Default abstract commands
[default]
  new_tab                     >> _Control{T}
  close_tab                   >> _Control{W}
  prev_tab                    >> _Control{PageUp}
  next_tab                    >> _Control{PageDown}
  navigate_back               >> _Alt{ArrowLeft}
  navigate_forward            >> _Alt{ArrowRight}

  # show_emoji_picker           >> $(rofimoji --selector-args="-normal-window" --skin-tone neutral --prompt emoji --keybinding-copy Control-c) ^
  show_emoji_picker           >> $(rofimoji --skin-tone neutral --prompt emoji --keybinding-copy Control-c) ^
  show_scene_picker           >> $($HOME/.config/regolith/rofi/rofi-hass-scene.sh) ^
  show_window_switcher        >> $(rofi -show window) ^
  show_run_menu               >> $(rofi -normal-window -show run) ^

  brightness_decrease         >> $(redshiftctl brightness -)
  brightness_increase         >> $(redshiftctl brightness +)
  brightness_reset            >> $(redshiftctl brightness =) ^
  color_temp_decrease         >> $(redshiftctl temperature -)
  color_temp_increase         >> $(redshiftctl temperature +)
  color_temp_reset            >> $(redshiftctl temperature =) ^

  mouse_drag                  >> (AltLeft ButtonLeft)
  mouse_drag_resize           >> (AltLeft ButtonRight)

  wm_center_window            >> $(i3-msg 'move absolute position center') ^
  wm_show_scratchpad          >> $(i3-msg 'scratchpad show') ^
  wm_show_terminal            >> !MetaRight Meta{X}
  wm_close_window             >> !MetaRight (MetaLeft Shift){Q} ^
  wm_float_window             >> !MetaRight Meta{Escape} ^
  wm_move_to_scratchpad       >> !MetaRight (MetaLeft Shift){Minus} ^
  wm_lock_desktop             >> ^ (Meta Control Shift){L}

  set_keyboard_layout_fi      >> $(gsettings set org.gnome.desktop.input-sources current GnomeInputSourceFI)
  set_keyboard_layout_us      >> $(gsettings set org.gnome.desktop.input-sources current GnomeInputSourceUS)

# vim: ft=perl sw=2 ts=2 sts=2 expandtab

