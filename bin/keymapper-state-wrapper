#!/usr/bin/env bash

set -euo pipefail

config_file="${XDG_CONFIG_HOME:-$HOME/.config}/keymapper.conf"
state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/keymapper/virtual"

cleanup() {
  # Release lock keys
  xdotool keyup Ctrl || true
  xdotool keyup Alt || true
  xdotool keyup Shift || true

  # Kill background processes
  kill "$(jobs -p)" 2> /dev/null || true

  # Ensure entr is not left running
  pkill -f "$state_dir" 2> /dev/null
}
trap cleanup EXIT

# Ensure only one instance of keymapper is running
pgrep -x keymapper &>/dev/null && kill $(pgrep -x keymapper)

# Clean up the keymapper state on config changes
ls "${config_file}" | entr -pn rm -rf "${state_dir}" &

/usr/bin/keymapper "$@"

